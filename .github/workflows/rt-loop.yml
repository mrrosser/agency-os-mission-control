name: rt-loop

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  rt-loop:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Cisco scanner tools
        run: |
          python -m pip install --upgrade pip
          pip install cisco-ai-skill-scanner cisco-ai-mcp-scanner

      - name: Install gitleaks
        env:
          GITLEAKS_VERSION: "8.24.2"
        run: |
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C /tmp
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Install deps
        run: npm ci

      - name: Write .env.local
        run: echo "${{ secrets.ENV_LOCAL }}" > .env.local

      - name: Run RT loop gates
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NEXT_TELEMETRY_DISABLED: "1"
          RT_ENABLE_CISCO_SCANNERS: "1"
          RT_AUTO_INSTALL_CISCO_SCANNERS: "0"
          RT_SECRETS_CMD: 'gitleaks dir --redact --report-format sarif --report-path "$ARTIFACTS_DIR/gitleaks.sarif" .'
        run: bash scripts/loop/run.sh
